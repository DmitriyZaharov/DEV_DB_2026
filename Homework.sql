--Дополнительное задание 2
--
--Работа с массивами
--    1. Объедините все элементы массива [192, 168,10,10] в строку, разделяя их с помощью 
--	символа точка (.)
SELECT array_to_string(ARRAY[192, 168, 10, 10], '.') AS ip_address;

--    2. Объедините все элементы массива ['Привет', NULL, 'специалисты', 'по БД'], 
-- 	разделяя их с помощью символа пробел. Значения NULL должны быть заменены на символ запятая (,):

--	Первый аргумент — сам массив.
--	Второй аргумент (' ') — основной разделитель (пробел) между элементами.
--	Третий аргумент (,) — строка, которая подставляется вместо каждого встреченного значения NULL.
SELECT array_to_string(ARRAY['Привет', NULL, 'специалисты', 'по БД'], ' ', ',') AS result;

--    3. Даны  2 массива  {"sql", "sqlserver"}  и {"database", "plsql"}.
--        a. Объедините эти массивы в один массив
--        b. Верните из объединенного массива 3 элемент 
--        c. Замените в массиве элемент sqlserver на  postgres
--        d. Верните из полученного массива последний элемент

  -- a. Объединяем два массива в один
SELECT ARRAY['sql', 'sqlserver'] || ARRAY['database', 'plsql'] AS combined_array;

 -- b. Получаем 3-й элемент (в SQL массивы начинаются с 1)
SELECT (ARRAY['sql', 'sqlserver'] || ARRAY['database', 'plsql'])[3] AS third_element;

-- c. Заменяем 'sqlserver' на 'postgres'
-- Используем array_replace(массив, что_заменить, на_что)
SELECT array_replace(
    ARRAY['sql', 'sqlserver'] || ARRAY['database', 'plsql'], -- Объединяем
    'sqlserver',                                             -- Что меняем
    'postgres'                                              -- На что меняем
) AS result;
--  d. Возвращаем последний элемент из полученного массива
--	cardinality(arr) — вычисляет количество элементов (в данном случае 4).
--	arr[...] — извлекает элемент по индексу. Так как в Postgres индексация начинается с 1, 
--	индекс последнего элемента всегда равен общему количеству элементов.
SELECT (ARRAY['sql', 'sqlserver'] || ARRAY['database', 'plsql'])
[cardinality(ARRAY['sql', 'sqlserver'] || ARRAY['database', 'plsql'])] AS last_element;
/*------------------------------------------------------------------------------------------------*/
WITH step_a AS (
    -- a. Объединяем два массива в один
    SELECT ARRAY['sql', 'sqlserver'] || ARRAY['database', 'plsql'] AS combined_arr
),
step_b AS (
    -- b. Возвращаем 3-й элемент из объединенного массива
    SELECT combined_arr, combined_arr[3] AS third_element 
    FROM step_a
),
step_c AS (
    -- c. Заменяем 'sqlserver' на 'postgres'
    SELECT array_replace(combined_arr, 'sqlserver', 'postgres') AS modified_arr 
    FROM step_a
)
-- d. Возвращаем последний элемент из измененного массива
SELECT 
    combined_arr,
    third_element,
    modified_arr,
    modified_arr[cardinality(modified_arr)] AS last_element
FROM step_b, step_c;
/*------------------------------------------------------------------------------------------------*/

--    4. Дана строка «Ваша_Фамилия, Ваше_Имя» с помощью функций преобразования строки в массив 
--    выполните разделение строки на элементы массива и верните отдельно Фамилию и Имя
--	Пример: 'Городецкая, Светлана'

WITH data_array AS (
    -- 1. Преобразуем строку в массив. 
    -- Разделитель здесь — запятая и пробел ', '
    SELECT string_to_array('Городецкая, Светлана', ', ') AS full_name_arr
)
-- 2. Извлекаем элементы по индексам (1 и 2)
SELECT 
    full_name_arr[1] AS last_name, -- Фамилия
    full_name_arr[2] AS first_name  -- Имя
FROM data_array;

--Работа с json
--Дан json, имеющий следующую структуру:
--{ "company_name": "Poupkine and Sons", "offices": [ { "name": "Главный", "city": "Париж", "area": 1000 }, { "name": "Запасной", "city": "Москва", "area" : 200 } ] }
--
--    1. Выведите список офисов
--    2. Выведите название компании
--    3. Выведите данные по первому в списке офису
--    4. Выведите название (name) второго офиса в списке офисов
--    5. Выполните проверку, наличия офиса в Санкт-Петербурге
--    6. Выполните замену города, в котором находится главный офис на город Сантк-Петербург